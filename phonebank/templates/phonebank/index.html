{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="referrer" content="same-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Phonebank</title>
    <link rel="icon" href="{% static 'boran.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha256-+IZRbz1B6ee9mUx/ejmonK+ulIP5A5bLDd6v6NHqXnI=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
    <style>
      body {
        padding-top: 5rem;
      }
      .alert, .btn-primary, .btn-secondary, .card {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <a class="navbar-brand" href="">Phonebank</a>
      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
          {% for nav_link in nav_links %}
          <li class="nav-item">
            <a class="nav-link" href="{{ nav_link.url }}" rel="noreferrer" target="_blank">{{ nav_link.name }}</a>
          </li>
          {% endfor %}
        </ul>
      <a href="https://en.wikipedia.org/wiki/Boran" rel="noreferrer" target="_blank"><img class="pull-right" src="{% static 'boran.png' %}" height="25px"/></a>
      </div>
    </nav>

    <main role="main" class="container-fluid">
      <div class="alerts"></div>
      <div class="row">
          <div class="col" id="formContainer">
            <iframe id="form" src="{{ google_form_url }}?usp=pp_url&embedded=true" width="100%" frameborder="0" marginheight="0" marginwidth="0" referrerpolicy="no-referrer">Loading…</iframe>
          </div>
          <div class="col-xl-3 col-lg-4 col-md-5">
            <div class="card">
              <h5 class="card-header"><span id="name"></span><span class="pull-right"><small class="text-muted"><span id="id"></span> <span id="statename"></span></small></span></h5>
              <div class="card-body">
                <div class="small" id="notes" style="font-family: monospace">
                </div>
                <div id="phones">
                  <div class="alert alert-primary" role="alert">
                    Before continuing, please place an echo test call to verify that your headphones and microphone are working correctly. You should be able to hear yourself speak once the call is active.
                  </div>
                </div>
                <div id="similar_voters">
                </div>
                <span class="pull-right">
                  <!-- Another echo test SIP URI address is sip:echo@iptel.org -->
                  <button type="button" class="btn btn-secondary" onclick="connectAndCall('sip:4444@sip2sip.info')" id="echo" disabled="true">Echo test
                    <i class="fa fa-phone" aria-hidden="true"></i>
                  </button>
                  <button type="button" class="btn btn-primary" onclick="getContact()" id="getContact" disabled="true">New contact
                    <i class="fa fa-user-plus" aria-hidden="true"></i>
                  </button>
                </span>
              </div>
            </div>
            <div class="card d-none" id="callInfo">
              <h5 class="card-header">
                <span id="callStatus"></span>
                <small class="text-muted" id="agentStats"></small>
                <button type="button" class="btn btn-danger pull-right d-none" onclick="currentCall.hangup()" id="hangupCall" disabled="true">Hangup
                  <i class="fa fa-close" aria-hidden="true"></i>
                </button>
              </h5>
              <div class="card-body">
                <div class="alert alert-secondary d-none" role="alert" id="callLogContainer">
                  <code id="callLog"></code>
                </div>
                <audio id="audioCall" autoPlay="autoplay"/>
              </div>
            </div>
          </div>
          <div class="col-xl-5 col-lg-4" id="meet">
          </div>
      </div>
    </main>

    <script
      src="https://browser.sentry-cdn.com/7.41.0/bundle.min.js"
      integrity="sha384-G2xNjblHi6NB8kRkcvFx2kqUMFeyS+OY+8SdfIqooyjTGC52RhRwhvMVcul/Adpv"
      crossorigin="anonymous"
    ></script>
    <script>
      if (window.navigator.userAgent.indexOf('Chrome') == -1 && window.navigator.userAgent.indexOf('Firefox') == -1) {
        alert("It looks like you're using a browser we don't support. Please try again with the latest version of Brave or Chrome.");
      }
      Sentry.init({ dsn: '{{ sentry_dsn }}' });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha256-/ijcOLwFf26xEYAjW75FizKVo5tnTYiQddPZoLUHHZ8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha256-QjIXq/h3XOotww+h/j4cXiTcNZqA8cN60pqGCUv+gdE=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.21/bundle/libphonenumber-js.min.js" integrity="sha256-m2S+cXlam/mJ+FFygyuk3ac1DVPCIzEeFfv0BoP5gtA=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/webrtc-adapter@8.2.1/out/adapter.js" integrity="sha256-tn/6nj2kh5eF1JIZ7VvROoCmrJd+K7Qm8JaT4HH3sLY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@telnyx/webrtc@2.9.0/lib/bundle.js" integrity="sha256-eztEU4iNdVeJds6ZY8b4xyYL7CudNMidKmbOowCKbYg=" crossorigin="anonymous"></script>
    <script src="https://{{ jitsi_server }}/external_api.js"></script>
    <script>
      const domain = '{{ jitsi_server }}';
      const room = '{{ jitsi_room }}';
      var jitsiApi;
      if(room) {
        const options = {
            roomName: '{{ jitsi_room }}',
            height: $(window).height() - 100,
            parentNode: document.querySelector('#meet'),
            configOverwrite: {startWithAudioMuted: true, startWithVideoMuted: true},
            userInfo: {displayName: '{{ agent_name }}'},
        };
        jitsiApi = new JitsiMeetExternalAPI(domain, options);
      } else {
        $('#meet').addClass('d-none');
      }

      $('#form').css('height', $(window).height() - 100);

      var agentStats = '';
      function getContact(id='') {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        const path = 'api/voter/' + (id && encodeURIComponent(id) + '/') + '?key=' + encodeURIComponent(key);
        $('#getContact').attr('disabled', true);
        $.getJSON(path, function(api) {
          $('#name').text(api.voter.name);
          $('#id').text('#' + api.voter.id);
          $('#statename').text(api.voter.statename);
          $('#notes').html(api.voter.notes);
          $('#phones').html('<ul class="nav nav-pills"></ul>');
          for (phonetype of Object.keys(api.voter.phones)) {
            const phone = api.voter.phones[phonetype];
            var icon;
            if (phonetype.includes('cell')) {
              icon = "fa-mobile";
            } else {
              icon = "fa-phone";
            }
            if (phone[0] == '+') {
              const phoneNumber = parseInt(phone.substring(1));
              if (!isNaN(phoneNumber)) {
                $('#phones ul').append('<li class="nav-item"><a class="nav-link" onclick="connectAndCall(\x27+' + phoneNumber + '\x27)" id="phone' + phoneNumber + '"><i class="fa ' + icon + '" aria-hidden="true"></i> ' + libphonenumber.parsePhoneNumberFromString('+' + phoneNumber).format('NATIONAL') + '</a></li>');
              }
            }
          }
          if (api.similar_voters.length != 0) {
            $('#similar_voters').html('<div class="alert alert-info" role="alert"><p>There are other voters with overlapping phone numbers:</p><ul></ul></div>');
            for (voter of api.similar_voters) {
              $('#similar_voters ul').append('<li><a href="javascript:getContact(\x27' + voter.id.replaceAll('\x27', '') + '\x27)"></a></li>');
              $('#similar_voters ul li:last a').text(voter.name)
              if (voter.provided) {
                $('#similar_voters ul li:last a').wrap('<strike>');
              }
            }
          } else  {
            $('#similar_voters').html('');
          }
          // When changing the iframe src or location.href, if there are
          // unsaved changes in the form, onbeforeunload will trigger an alert
          // about leaving the site. If this alert is canceled by the user, the
          // form will erroneously remain filled with the previous voter.
          // So to preempt this alert, we overwrite the entire iframe element.
          $("#formContainer").html('<iframe id="form" src="' + '{{ google_form_url }}?usp=pp_url&entry.391576799=' + encodeURIComponent(api.voter.id) + '&entry.1578854864=' + encodeURIComponent(Object.values(api.voter.phones).join(',')) + '&entry.1498627907=' + encodeURIComponent(key) + '&embedded=true' + '" width="100%" frameborder="0" marginheight="0" marginwidth="0" referrerpolicy="no-referrer">Loading…</iframe>');
          $('#form').css('height', $(window).height() - 100);
          agentStats = api.agent_stats;
        }).fail(function(jqxhr) {
          warning('Unable to fetch new contact: ' + (jqxhr.responseText || jqxhr.statusText));
        }).always(function() {
          $('#getContact').attr('disabled', false);
        });
        $('#agentStats').text('');
      }

      // Adapted from https://github.com/team-telnyx/webrtc/blob/master/packages/js/examples/vanilla/index.html
      var telnyxClient = null;
      var telnyxToken = null;
      var currentCall = null;
      function telnyxConnect() {
        telnyxClient = new TelnyxWebRTC.TelnyxRTC({
          login_token: telnyxToken,
        });
        telnyxClient.remoteElement = 'audioCall';
        telnyxClient
        .on('telnyx.ready', function () {
          console.log('Telnyx ready');
        })
        .on('telnyx.socket.close', function () {
          console.log('Disconnected from Telnyx');
        })
        .on('telnyx.notification', handleNotification);
        console.log('Connecting to Telnyx');
        telnyxClient.connect();
      }
      function telnyxDisconnect() {
        console.log('Disconnecting from Telnyx');
        telnyxClient.disconnect();
      }
      function handleNotification(notification) {
        switch (notification.type) {
          case 'callUpdate':
            handleCallUpdate(notification.call);
            break;
          case 'vertoClientReady':
            break;
          default:
            warning(notification.type);
            break;
        }
      }
      function handleCallUpdate(call) {
        currentCall = call;
        $('#callStatus').text("Call " + call.state);
        switch (call.state) {
          case 'new': // Setup the UI
            break;
          case 'trying': // You are trying to call someone and he's ringing now
            break;
          case 'recovering': // Call is recovering from a previous session
            if (confirm('Recover the previous call?')) {
              currentCall.answer();
            } else {
              currentCall.hangup();
            }
            break;
          case 'ringing': // Someone is calling you
            //used to avoid alert block audio play, I delayed to audio play first.
            setTimeout(function () {
              if (confirm('Pick up the call?')) {
                currentCall.answer();
              } else {
                currentCall.hangup();
              }
            }, 1000);
            break;
          case 'active': // Call has become active
            break;
          case 'hangup': // Call is over
            break;
          case 'destroy': // Call has been destroyed
            $('#hangupCall').addClass('d-none');
            $('#hangupCall').attr('disabled', true);
            currentCall = null;
            $('#echo').attr('disabled', false);
            $('#getContact').attr('disabled', false);
            $('#callStatus').text('');
            $('#agentStats').text(agentStats);
            break;
        }
        if (typeof call.cause != 'undefined' && call.cause != 'NORMAL_CLEARING' && call.state != 'destroy') {
          $('#callLogContainer').removeClass('d-none')
          $('#callLog').append(document.createTextNode(call.cause + ' (' + call.sipCode + ' ' + call.sipReason + ')\n'));
        }
      }

      function connectAndCall(phone) {
        if (telnyxClient == null || telnyxClient.connected != true) {
          const urlParams = new URLSearchParams(window.location.search);
          const key = urlParams.get('key');
          const path = 'api/voter/0/?key=' + encodeURIComponent(key);
          $.getJSON(path, function(api) {
            telnyxToken = api.telnyx_token;
            telnyxConnect();
            telnyxClient.on('telnyx.ready', function() {
              makeCall(phone);
            });
            agentStats = api.agent_stats;
          }).fail(function(jqxhr) {
            warning('Unable to place call: ' + (jqxhr.responseText || jqxhr.statusText));
          });
        } else {
          makeCall(phone);
        }
      }

      function makeCall(phone) {
        if (currentCall != null) {
          warning("Call already ongoing");
          return;
        }
        if (room) {
          jitsiApi.isAudioMuted().then(muted => {
            if(!muted) {
              warning("Please mute conference audio during call")
            }
          });
        }
        const params = {
          destinationNumber: phone,
          audio: 1,
        };
        if (phone[0] == '+') {
          const phoneNumber = parseInt(phone.substring(1));
          if (!isNaN(phoneNumber)) {
            $('#phone' + phoneNumber).addClass('text-muted');
          }
        }
        $('#agentStats').text('');
        $('#callInfo').removeClass('d-none');
        $('#callLog').html('');
        $('#callLogContainer').addClass('d-none');
        currentCall = telnyxClient.newCall(params);
        $('#getContact').attr('disabled', true);
        $('#echo').attr('disabled', true);
        $('#hangupCall').removeClass('d-none');
        $('#hangupCall').attr('disabled', false);
      }

      function warning(message) {
        console.warn(message);
        $('.alerts').append('<div class="alert alert-warning alert-dismissible fade show" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
        $('.alerts .alert:last').prepend(document.createTextNode(message))
        $('.alert-dismissible').alert()
      }

      $(document).ready(function() {
        $('#echo').attr('disabled', false);
        $('#getContact').attr('disabled', false);
      });

      $(document).keydown(function(e) {
        if (currentCall != null && !e.originalEvent.repeat && "0123456789#*".includes(e.key)) {
          currentCall.dtmf(e.key);
        }
      });
    </script>
  </body>
</html>
